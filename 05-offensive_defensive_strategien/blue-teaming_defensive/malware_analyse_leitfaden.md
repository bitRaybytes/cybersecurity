# Leitfaden zur Malware Analyse

## Inhaltsverzeichnis
- [Einleitung](#einleitung)
- [Stufe 1: Basis-Analyse (Triage)](#stufe-1-basis-analyse-triage)
    - [Checksum (Hash-Werte)](#checksum-hash-werte)
    - [Rolle in der Analyse](#rolle-in-der-analyse)
    - [Gängige Hash-Algorithmen](#gängige-hash-algorithmen)
    - [Online Sandboxing](#online-sandboxing)
    - [Virus Total](#virus-total)
- [Stufe 2: Statische Analyse](#stufe-2-statische-analyse)
    - [Dateityp und Header-Analyse](#dateityp-und-header-analyse)
    - [String-Extraktion](#string-extraktion)
    - [Packer- und Obfuskationserkennung](#packer--und-obfuskationserkennung)
- [Stufe 3: Dynamische Analyse (Verhaltensanalyse)](#stufe-3-dynamische-analyse-verhaltensanalyse)
    - [Isolierte Umgebung (The Lab)](#isolierte-umgebung-the-lab)
    - [Überwachungsbereiche](#überwachungsbereiche)
    - [Debugging](#debugging)
- [Nützliche Links](#nützliche-links)
- [Haftungsausschluss](#haftungsausschluss)


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

## Einleitung
Die **Malware Analyse** ist ein zentraler Baustein der **Blue-Team-Aktivitäten** und der gesamten Incident Response. Ihr Kernziel ist es, schadhafte Programme (Malware) schnell und systematisch zu verstehen, um geeignete Abwehrmaßnahmen (Signaturerstellung, Blacklisting von Command & Control-Servern) für die eigenen Organisationsstrukturen zu entwickeln.

Es gibt verschiedene Methoden, die in zwei Hauptkategorien unterteilt werden: **Statische** und **Dynamische** Analyse.


```text
+------------------------------------+
| 1. Triage (Vorbewertung)           |
| (Hash-Prüfung, Sandboxing)         |
+------------------+-----------------+
                   |
                   V
+------------------+-----------------+
| 2. Statische Analyse               |
| (Strings, Header, Imports/Exports) |
+------------------+-----------------+
                   |
                   V
+------------------+-----------------+
| 3. Dynamische Analyse              |
| (Sandbox / Labor: Monitoring, C2)  |
+------------------+-----------------+
                   |
                   V
+------------------+--------------------+
| 4. Berichterstellung & Gegenmaßnahmen |
| (IOCs, Signaturerstellung, Defense)   |
+---------------------------------------+ 
```



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

## Stufe 1: Basis-Analyse (Triage)

Diese erste Stufe dient der schnellen Identifizierung und Risikobewertung.


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Checksum (Hash-Werte)
Ein **Checksum** (Hash-Wert) ist das Resultat einer mathematischen Berechnung, bei der eine Eingabe (die Datei) mit einem kryptografischen Algorithmus (z. B. SHA256) verschlüsselt wird, sodass eine einzigartige, fixe Zeichenfolge entsteht.



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

### Rolle in der Analyse
- **Identifikation:** Ein Hash-Wert dient als digitaler Fingerabdruck. Ist er in einer **Threat Intelligence** (**TI**) Datenbank bekannt, kann die Malware schnell identifizieren und klassifiziert werden (z.B als "Emotet Loader")

- **Integritätsprüfung:** Bestätigt, dass die analyiserte Datei während der Übertragung nicht verändert wurde.


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Gängige Hash-Algorithmen
| Algorithmus | Länge (Bits) | Länge (Hex-Zeichen) | Verwendung |
| :--- | :--- | :--- | :--- |
| MD5 | 128 | 32 | Veraltet (Kollisionen möglich), aber noch häufig genutzt. |
| SHA-1 | 160 | 40 | Veraltet (Kollisionen möglich). |
| SHA-256 | 256 | 64 | Aktueller Standard für Malware-Identifikation. |



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Online Sandboxing
Sandboxing ist die Ausführung der Malware in einer isolierten, sicheren virtuellen Umgebung, um ihr Verhalten zu beobachten, ohne das Host-System zu gefährden.

| **Vorteile** | **Nachteile** |
|--------------|---------------|
| **Automatisierung:** Liefert schnell einen ersten Bericht über das Verhalten der Malware (Dateierstellung, Registry-Änderung, Netzwerkverbindungen). | Viele Malware-Varianten erkennen, wenn sie in einer Sandbox ausgeführt werden, und bleiben inaktiv (**Sandobox Evasion**). | 
| **IOC-Extraktion:** Extrahiert sofort **Indicators of Compromise** (**ICOs**) wie IP-Adressen und Domain-Namen der Command & Control (C2) Server | |


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Virus Total
[Virus Total](https://www.virustotal.com/gui/home/upload) ist eine öffentliche Online-Plattform, die die Malware-Probe durch Dutzende verschiedener Antiviren-Engines analysiert und die Ergebnisse bereitstellt.

- **Nutzen:**
  - **Ersteinschätung:** Zeigt, wie viele Hersteller die Datei als schädlich einstufen.
  - **Community-Beiträge:** Bietet oft statische Informationen (PE-Header-Daten) und Kommentare von anderen Analysten.



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Stufe 2: Statische Analyse
Die statische Analyse untersucht die Malware-Datei **ohne sie auszuführen**. Sie konzentriert sich auf die internen Daten und die Struktur der Datei.



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Dateityp und Header-Analyse
Die Untersuchung des **PE-Headers** (**Portable Executable**) - des Standardformats für Windows-Ausführungsdateien - gibt Aufschluss über:

- **Kompilierungszeitstempel:** Kann Hinweise auf das Alter der Malware geben (oft gefälscht).
- **Architektur:** 32-Bit oder 64-Bit.
- **Sektionen:** Zeigt, wie der Code organisiesrt ist (z.B. `.text` für Code, `.data`für initialisierte Daten).
- **Importierte Funktionen (Imports):** Die von der Malware genutzten System-APIs. Dies ist ein wichtiger Indikator für ihre Absicht (z. B. `WriteFile` deutet auf Dateimanipulation hin, `WSAConnect` auf Netzwerkkommunikation).



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### String-Extraktion
Das Extrahieren aller lesbaren Textketten (Strings) aus der Binärdatei kann schnell verrwertbare Informationen liefern:

- **Dateinamen:** Name, die die Malware erstellt oder sucht.
- **Registry-Schlüssel:** Schlüssel, die für Persistenz verwendet werden (z. B. `Run` Schlüssel).
- **IP-Adressen/URLs:** Potentielle C2-Server-Adressen.
- **Fehlermeldungen oder Mutex-Namen** (**Mu**tual **Ex**clusion).

  
> Ein **Mutex-Namen** ist die Bezeichnung für eine benannte Sperre (Mutex), die es mehreren Prozessen oder Threads ermöglicht, einen gemeinsamen Ressourcenzugriff über den Namen zu synchronisieren und so Konflikte zu verhindern.



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Packer- und Obfuskationserkennung
Viele Schädliche Programme verwenden **Packer** (wie UPX oder Themidia), um ihren Code zu verschleiern (**Obfuskation**).

- **Erkennung:** Wenn der PE-Header ungewöhnliche Sektionen oder stark komprimierte Sektionen aufweist.
- **Maßnahmen:** Die Walware muss zunächst entpackt werden, bevor eine tiefere Analyse möglich ist.



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Stufe 3: Dynamische Analyse (Verhaltensanalyse)
Die dynamische Analyse beinhaltet die **Ausführung der Malware in einer isolierten Umgebung (Malware Lab)**, um ihr tatsächliches Verhalten und ihre Interaktionen mit dem Betriebssystem zu beobachten.


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Isolierte Umgebung (The Lab)

- Dies muss eine **virtuelle Maschine** sein, die vom Host-Netzwerk getrennt ist (**Air-Gapped**) oder nur über ein simuliertes Internet verfügt, um eine Infektion zu verhindern.

- **Wichtige Tools:** **Fiddler/Wireshark** (Netzwerkverkehr), **Procmon/Regshot** (Dateisystem/Registry-Änderungen), **Debugger** (z. B. x64dbg).



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Überwachungsbereiche
| Bereich | Beobachtete Aktivitäten | Extrahiertes IOC |
|---------|-------------------------|------------------|
| **Prozesse** | Start neuer Prozesse, Prozess-Injektion (Code-Injection) in legitime Prozesse. | PID, injizierter Code. |
| **Dateisystem** | Erstellung, Löschung oder Modifikation von Dateien. | Pfade zu Dropper-Dateien, Konfigurationsdateien. |
| **Registry** | Hinzufügen von **Persistenz-Schlüssel** (z. B. in `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`). |
| **Netzwerkverkehr** | Kommunikation mit externen Servern, DNS-Anfragen. | IP-Adressen, Domain-Namen, Ports, Protokoll (z. B. HTTPS, DNS). |



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Debugging
- Bei komplexer Malware (oder bei Obfuskation) ist das **Debugging** der letzte Schritt. Hierbei wird der Code schrittweise ausgeführt, um die Programmlogik, Entschlüsselungsroutinen oder Anti-Analyse-Checks zu verstehen.


<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Nützliche Links
- [Hybrid Analysis - Freies Malware Analyse Tool (online)](https://hybrid-analysis.com/)
- [HexEd.it - Online Hex-Editor](https://hexed.it/)
- [ANY.RUN - interaktive Online-Malware-Sandbox](https://any.run/)
- [PEStudio - Freies Tool zur PE-Header-Analyse](https://www.winitor.com/)
- [Microsoft Process Monitor (Procmon) - Unverzichtbar für die dynamische Analyse](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon)
- [TryHackMe Room: MAL: Researching](https://tryhackme.com/room/malresearching)



<div align=right>

[↑ Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Haftungsausschluss

Dieses Repository dient ausschließlich zu Ausbildungs-, Forschungs- und Demonstrationszwecken im Bereich der IT-Sicherheit.

Alle hier dokumentierten Techniken und Tools dürfen nur in legalen und autorisierten Testumgebungen verwendet werden – z. B. in Labors, CTFs oder mit ausdrücklicher Genehmigung des Eigentümers der Zielsysteme.

Wir distanzieren uns ausdrücklich von jeglicher illegalen Nutzung.
Dieses Projekt richtet sich an White-Hat-Sicherheitsforscher, Ethical Hacker und Auszubildende, die ethisch und rechtlich korrekt handeln.

[Disclaimer](/00-disclaimer/disclaimer.md)

---

Stay curious – stay secure. 🔐

🗓️ **Letzte Aktualisierung:** September 2025  
🤝 **Pull Requests willkommen** – Vorschläge für neue Kurse oder Kategorien gerne einreichen!

---