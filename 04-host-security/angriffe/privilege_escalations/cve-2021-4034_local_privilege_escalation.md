# üõ°Ô∏è PwnKit-Analyse: Lokale Privilegieneskalation (CVE-2021-4034)

## Inhaltsverzeichnis
- [Einleitung - Was ist Polkit?](#einleitung---was-ist-polkit)
- [LPE durch fehlerhafte Pfadbehandlung in `pkexec`](#lpe-durch-fehlerhafte-pfadbehandlung-in-pkexec)
    - [1. √úberblick und Klassifizierung](#1-√ºberblick-und-klassifizierung)
    - [2. Technische Merkmale der Schwachstelle](#2-technische-merkmale-der-schwachstelle)
    - [3. Practice Lab: TryHackMe PwnKit (CVE-2021-4034)](#3-practice-lab-tryhackme-pwnkit-cve-2021-4034)
    - [4. Gegenma√ünahmen und Mitigation](#4-gegenma√ünahmen-und-mitigation)
- [N√ºtzliche Links](#n√ºtzliche-links)
- [Haftungsausschluss](#haftungsausschluss)


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

## Einleitung - Was ist Polkit?

Polkit (ehemals PolicyKit) ist ein zentrales Autorisierungsframework in Unix-artigen Betriebssystemen, insbesondere Linux. Es dient nicht der reinen Authentifizierung (Passwortpr√ºfung), sondern der Autorisierung.

Polkit stellt die Regeln (Policies) auf, die festlegen, ob ein nicht-privilegierter Benutzer die Berechtigung hat, eine privilegierte Aktion durchzuf√ºhren (z. B. Systemdienste verwalten, Software installieren oder Systemzeiten √§ndern).

- `pkexec` ist das Kommandozeilenwerkzeug von Polkit, das als Ersatz f√ºr `su` und `sudo` dienen kann. Da es Aktionen im Namen des Root-Benutzers ausf√ºhrt, ist das SUID-Bit gesetzt. PwnKit nutzt genau diese privilegierte Ausf√ºhrung, um die Autorisierungsmechanismen zu umgehen.

> Du kannst auf [**tryhackme.com** den Raum Pwnkit: CVE-2021-4034](https://tryhackme.com/room/pwnkit) besuchen, um mehr √ºber diese Schwachstelle zu erfahren und sie in den eigenen Labs ausprobieren.


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

## LPE durch fehlerhafte Pfadbehandlung in `pkexec`

### 1. √úberblick und Klassifizierung

| Attribut | Wert |
|----------|------|
| CVE-ID | CVE-2021-4034 (PwnKit) |
| Kategorie | Lokale Privilegieneskalation (LPE) |
| Betroffenes Produkt | `pkexec` (Teil von polkit, oft auf Linux-Systemen installiert) |
| Schweregrad (CVSS v3.1) | 7.8 (High) |
| Schwachstellentyp | Buffer Overflow (Speicher√ºberlauf) und Improper Handling of Environment Variables |
| Ausf√ºhrungsberechtigung | Jeder lokale, nicht-privilegierte Benutzer. |



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

#### Kurzeinleitung zum Exploit

PwnKit nutzt eine Schwachstelle in der Verarbeitung von Umgebungsvariablen durch das Programm `/usr/bin/pkexec`. Dieses Programm ist standardm√§√üig auf vielen modernen Linux-Distributionen installiert und hat das SUID (Set User ID)-Bit gesetzt, d.h., es l√§uft immer mit Root-Rechten, unabh√§ngig davon, welcher Benutzer es startet.

Der Exploit erm√∂glicht es jedem lokalen Benutzer, Root-Rechte zu erlangen, indem er manipulierte Argumente und Umgebungsvariablen an `pkexec` √ºbergibt. Die Schwachstelle ist seit der Einf√ºhrung von `pkexec` im Jahr 2009 vorhanden und wurde im Januar 2022 √∂ffentlich.



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

### 2. Technische Merkmale der Schwachstelle

#### 2.1 Der fehlerhafte Argumenten-Index (`argv`)
Der Kern des Problems liegt in der `main`-Funktion von `pkexec` und der Art, wie sie die √ºbergebenen Argumente (gespeichert in `argv[]`) iteriert.

Normalerweise sollte das Argumenten-Array `argv` so aussehen:

- `argv[0]` ist immer der Pfad zum ausgef√ºhrten Programm (`/usr/bin/pkexec`).
- `argv[1]`, `argv[2]`, usw. sind die vom Benutzer √ºbergebenen Argumente.

Die fehlerhafte Implementierung in der initialen Codebasis von `pkexec` (seit 2009) beginnt die Schleife, die die Argumente verarbeitet, bei einem falschen Index:

```bash
for (n = 1; n < argc; n++) {
  // Verarbeite Argumente
}
```


Wenn der Benutzer `pkexec` ohne zus√§tzliche Argumente aufruft (d.h., nur als `pkexec`), ist die Anzahl der Argumente (`argc`) gleich 1. Die Schleife wird sofort beendet, da $\text{n=1}$ und $\text{n<1}$ falsch ist. Dies ist das korrekte Verhalten.


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


#### 2.2 Ausnutzung durch das √úberspringen der Pfadbereinigung

Das Problem entsteht, wenn die Umgebungsvariablen manipuliert werden. Im Linux-Speicher folgen die Umgebungsvariablen (`envp[]`) direkt auf das Argumenten-Array (`argv[]`).

Wenn ein Angreifer `pkexec` so aufruft, dass `argc` (die Anzahl der Argumente) den Wert **0** hat, oder ein Argument √ºbergibt, das `argv` manipuliert (z. B. durch √úbergabe eines leeren Strings als Argument), springt die Argumentenverarbeitung von `pkexec` in den Speicherbereich der Umgebungsvariablen (`envp`).


Der Exploit erzwingt effektiv:

1. Dass der interne Code die Umgebungsvariable `PATH` des Angreifers (z.B. `PATH=./` oder `PATH=GCONV_PATH=./`) als eines der ersten Argumente interpretiert.

2. Weil der `pkexec`-Code die Argumente √ºberspringt, wird die kritische `PATH`-Bereinigungslogik umgangen, die verhindern sollte, dass Shell-Code √ºber die Umgebung geladen wird.

In der Folge versucht `pkexec` (das mit Root-Rechten l√§uft), eine ben√∂tigte interne Hilfsfunktion zu finden und zu laden. Da der manipulierte `PATH` (durch die fehlerhafte Argumentenbehandlung) noch aktiv ist, l√§dt `pkexec` die b√∂sartige Shared Library (die eine Root-Shell ausf√ºhrt) anstelle der erwarteten Systemdatei.


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

### 3. Practice Lab: TryHackMe PwnKit (CVE-2021-4034)

Die TryHackMe-Challenge demonstriert die LPE-Kette von PwnKit. Dazu wurde das Programm vom GitHub-User `arthepsy` verwendet, dass du [hier findest](https://github.com/arthepsy/CVE-2021-4034/tree/main).

#### 3.1 Vorbereitung und Kompilierung

Da der Exploit erfordert, dass die b√∂sartige Shared Library im Kontext von `pkexec` geladen wird, ist die Kompilierung eines Exploit-Codes oft der erste Schritt.

- **Voraussetzung:** Stellen Sie sicher, dass die notwendigen Compiler-Tools installiert sind (z.B. `gcc`).

- **Exploit-Code-Download:** Der Exploit-Code wird auf das Zielsystem heruntergeladen (z.B. von einem GitHub-Repository).

- **Kompilierung:** Der C-Code wird zu einer ausf√ºhrbaren Datei oder Shared Library kompiliert.

```bash
# Beispiel-Kompilierungsschritt
gcc pwnkit.c -o pwnkit -lcrypt
```


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

#### 3.2 Ausnutzung und Privilegienerh√∂hung

Nach der Kompilierung wird der Exploit ausgef√ºhrt.

1. Der Befehl `./pwnkit` f√ºhrt den kompilierten Exploit aus, der die fehlerhafte Argumentbehandlung in `pkexec` nutzt.

2. Der Befehl `whoami` pr√ºft die effektive Benutzer-ID (UID) nach der Ausf√ºhrung.


Nachweis der erfolgreichen Ausnutzung:

Der Exploit f√ºhrt zu einer neuen Shell-Sitzung, in der der Benutzer whoami oder id ausf√ºhren kann. Die Ausgabe sollte root oder uid=0(root) lauten.

```bash
# Beispiel-Ausgabe nach erfolgreicher Ausnutzung
# id
uid=0(root) gid=0(root) groups=0(root),...

# whoami
root
```

#### Nachweis des Exploits

![Locale Privilege Escalation](/04-host-security/angriffe/privilege_escalations/assets/cve-2021-4034-screenshot-01.png)


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

### 4. Gegenma√ünahmen und Mitigation

PwnKit ist extrem gef√§hrlich, da es lokal ist, leicht ausf√ºhrbar ist und fast alle g√§ngigen Linux-Distributionen betrifft.

- **Aktualisierung:** Die einzige zuverl√§ssige Gegenma√ünahme ist die sofortige Aktualisierung des polkit-Pakets auf eine gepatchte Version (z. B. `polkit-0.120-2` oder h√∂her, abh√§ngig von der Distribution).

- **Entfernung (Notl√∂sung):** Wenn ein sofortiges Patching nicht m√∂glich ist, kann das SUID-Bit von `pkexec` entfernt werden, um die Ausf√ºhrung mit Root-Rechten zu verhindern. Dies kann jedoch die Funktionalit√§t anderer Systemkomponenten beeintr√§chtigen, die auf `pkexec` angewiesen sind.

```bash
# Nicht empfohlen in Produktionsumgebungen ohne vorherige Tests!
chmod 0755 /usr/bin/pkexec
```

- **Endpoint Detection and Response (EDR):** Moderne EDR-L√∂sungen erkennen typischerweise die Ausf√ºhrung eines pkexec-Befehls mit einem ungew√∂hnlichen argv und k√∂nnen die Ausf√ºhrung blockieren.


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>

## N√ºtzliche Links
- [TryHackeMe: Pwnkit: CVE-2021-4034](https://tryhackme.com/room/pwnkit)
- [GitHub @arthepsy (PoC for PwnKit)](https://github.com/arthepsy/CVE-2021-4034/tree/main)
- [Wikipedia: Polkit](https://de.wikipedia.org/wiki/Polkit)
- [Qualsys Security Advisory Dokumentation](https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt)
- [Qualsys Blog-Artikel: PwnKit: Local Privilege Escalation Vulnerability Discovered in polkit‚Äôs pkexec (CVE-2021-4034)](https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034)

<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Haftungsausschluss

Dieses Repository dient ausschlie√ülich zu Ausbildungs-, Forschungs- und Demonstrationszwecken im Bereich der IT-Sicherheit.

Alle hier dokumentierten Techniken und Tools d√ºrfen nur in legalen und autorisierten Testumgebungen verwendet werden ‚Äì z.‚ÄØB. in Labors, CTFs oder mit ausdr√ºcklicher Genehmigung des Eigent√ºmers der Zielsysteme.

Wir distanzieren uns ausdr√ºcklich von jeglicher illegalen Nutzung.
Dieses Projekt richtet sich an White-Hat-Sicherheitsforscher, Ethical Hacker und Auszubildende, die ethisch und rechtlich korrekt handeln.

[Disclaimer](/00-disclaimer/disclaimer.md)

--- 

Stay curious ‚Äì stay secure. üîê

üóìÔ∏è **Letzte Aktualisierung:** Oktober 2025  
ü§ù **Pull Requests willkommen** ‚Äì Vorschl√§ge f√ºr neue Kurse oder Kategorien gerne einreichen!

---