# üíÄ Sudoers-Buffer-Overflow-Analyse (pwfeedback): CVE-2019-18634

## Inhaltsverzeichnis
- [Einf√ºhrung und Kurzbeschreibung](#einf√ºhrung-und-kurzbeschreibung)
- [1. Technische Details der Schwachstelle](#1-technische-details-der-schwachstelle)
- [2. Die Rolle der `pwfeedback`-Option](#2-die-rolle-der-pwfeedback-option)
    - [Der Angriffsvektor](#der-angriffsvektor)
- [3. Praktische Analyse und Nachweise (PoC)](#3-praktische-analyse-und-nachweise-poc)
    - [Nachweis 1: √úberpr√ºfung der `pwfeedback`-Aktivierung](#nachweis-1-√ºberpr√ºfung-der-pwfeedback-aktivierung)
    - [Nachweis 2: Ausl√∂sen eines Segmentation Fault](#nachweis-2-ausl√∂sen-eines-segmentation-fault)
    - [Nachweis 3: Erfolgreiche Rechteausweitung (Privilege Escalation)](#nachweis-3-erfolgreiche-rechteausweitung-privilege-escalation)
- [4. Funktionsweise des Exploits (Konzeptionell)](#4-funktionsweise-des-exploits-konzeptionell)
    - [Ziel der Heap-Korrumpierung](#ziel-der-heap-korrumpierung)
    - [Exploit Code ‚Äì Konzeptionelle Logik](#exploit-code--konzeptionelle-logik)
- [5. Impact und Betroffene Systeme](#5-impact-und-betroffene-systeme)
- [6. Gegenma√ünahmen (Mitigation)](#6-gegenma√ünahmen-mitigation)
    - [Patchen des Sudo-Pakets (Prim√§re Ma√ünahme)](#patchen-des-sudo-pakets-prim√§re-ma√ünahme)
    - [Deaktivierung von `pwfeedback` (Fallback-Ma√ünahme)](#deaktivierung-von-pwfeedback-fallback-ma√ünahme)
    - [H√§rtung (Hardening)](#h√§rtung-hardening)
- [Haftungsausschluss](#haftungsausschluss)




<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Einf√ºhrung und Kurzbeschreibung

Die CVE-2019-18634 beschreibt eine schwerwiegende Sicherheitsl√ºcke im Sudo-Programm von Linux, die einen Heap-basierten Puffer√ºberlauf (**Buffer Overflow**) erm√∂glicht. Im Gegensatz zu vielen anderen Sudo-Schwachstellen ist diese L√ºcke an eine spezifische Konfigurationsoption gebunden: `pwfeedback`.

Wenn diese Option aktiviert ist, kann ein lokaler Benutzer ohne Root-Rechte, der in die Gruppe `sudo` (oder eine √§hnliche Gruppe mit Sudo-Berechtigungen) f√§llt, durch Senden einer speziell pr√§parierten Eingabe beliebigen Code mit Root-Privilegien ausf√ºhren.

| Attribut | Details |
|----------|---------|
| CVE-ID | CVE-2019-18634 | 
| Betroffenes Programm | Sudo (spezifische Versionen) |
| Schwachstellentyp | Heap-based Buffer Overflow (Puffer√ºberlauf) |
| Erforderliche Bedingung | Die Sudo-Option pwfeedback muss in `/etc/sudoers` aktiviert sein. |
| Maximaler Impact | Lokale Rechteausweitung auf Root (`UID 0`). |



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## 1. Technische Details der Schwachstelle

Die Schwachstelle befindet sich in der Funktion, die f√ºr die Verarbeitung des Benutzerpassworts verantwortlich ist, wenn dieses √ºber das Terminal eingegeben wird.

Normalerweise wird die Passworteingabe durch die Funktion `read_nonblock` in einen Puffer (`user_details.buffer`) gelesen. Wenn die Option pwfeedback aktiviert ist, versucht Sudo, das Echo-Feedback (die `*`-Zeichen) nach der Passworteingabe zu handhaben, auch wenn die Eingabe ung√ºltig war oder abgebrochen wurde.

Der kritische Fehler liegt in der Funktion `tgetpass.c`, wo der Input vom Terminal (TTY-Device) unkontrolliert in einen Puffer fester Gr√∂√üe kopiert wird, ohne eine ausreichende L√§ngenpr√ºfung.


> **Hinweis:** Ein Heap-basierter Puffer√ºberlauf ist oft schwieriger auszunutzen als ein Stack-basierter. Im Falle von CVE-2019-18634 erm√∂glicht die Kontrolle √ºber die Gr√∂√üe und den Inhalt des Buffers jedoch die Korrumpierung des Heap-Metadatenbereichs, was eine Arbitrary Write Primitive (M√∂glichkeit, beliebige Daten an beliebige Stellen im Speicher zu schreiben) erm√∂glicht.



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## 2. Die Rolle der `pwfeedback`-Option

Die Option `pwfeedback` ist der absolute Schl√ºssel zur Ausnutzung dieser CVE. Ohne sie ist die Schwachstelle nicht existent.

Die Option wurde eingef√ºhrt, um dem Benutzer eine visuelle R√ºckmeldung zu geben, wenn er sein Passwort eingibt. Anstatt das Passwort unsichtbar zu lassen (wie Standard), wird f√ºr jeden eingegebenen Buchstaben ein Stern (`*`) angezeigt.

In der sudoers-Datei ist die Option wie folgt festgelegt:

```text
Defaults pwfeedback
```


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Der Angriffsvektor

Die `pwfeedback`-Funktionalit√§t liest die TTY-Eingabe in einem Modus, der dem Angreifer erm√∂glicht, eine sehr gro√üe Menge an Daten in einem einzigen Block zu senden. Die Leseoperation f√ºllt den Puffer (`user_details.buffer`), der f√ºr die Passwortverarbeitung gedacht war, bis er √ºberl√§uft und angrenzende Heap-Speicherstrukturen (Metadaten) √ºberschreibt.



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## 3. Praktische Analyse und Nachweise (PoC)

Dieser Abschnitt dokumentiert die erfolgreiche Verifizierung und Ausnutzung der Schwachstelle CVE-2019-18634 in einer kontrollierten Laborumgebung (TryHackMe-Umgebung).


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Nachweis 1: √úberpr√ºfung der `pwfeedback`-Aktivierung

Der entscheidende erste Schritt bei dieser Schwachstelle ist der Nachweis, dass die `pwfeedback`-Option in der Konfiguration aktiv ist.

- **Beobachtung:** Durch das Anzeigen der Konfigurationsdatei `/etc/sudoers` oder durch die Beobachtung der Terminal-R√ºckmeldung bei Passworteingabe f√ºr sudo konnte die aktive Option Defaults pwfeedback best√§tigt werden.

![Nachweis 1: `pwfeedback` Aktivierung √ºberpr√ºfen](/04-host-security/angriffe/privilege_escalations/assets/CVE-2019-18634-screenshot-2_check_pwfeedback.png)



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>



### Nachweis 2: Ausl√∂sen eines Segmentation Fault

Um zu beweisen, dass die anf√§llige Funktion tats√§chlich einem Puffer√ºberlauf unterliegt, wird ein kontrollierter Angriff mit exzessiver Eingabe durchgef√ºhrt, der zu einem Absturz (`Segmentation Fault`) des Sudo-Prozesses f√ºhrt.

- **Befehl:** Wir nutzen den `perl`-Befehl, um eine gro√üe Menge an Daten in den Standardeingabestrom zu schreiben, und pipen diese an `sudo -S id`. Das `\x{00}` (Null-Byte) dient dabei oft zur Terminierung der Eingabe, um eine saubere √úbergabe zu erzwingen.

```bash
perl -e 'print(("A" x 100 . "\x{00}) x 50)' | sudo -S id
```

- **Erwartetes Ergebnis:** Der Sudo-Prozess versucht, die riesige Eingabe in den festen Puffer zu lesen, was zu einer √úberschreibung der Heap-Metadaten und einem Segmentation Fault f√ºhrt, da der Prozess versucht, auf unzul√§ssigen Speicher zuzugreifen.

![Segmentation Fault](/04-host-security/angriffe/privilege_escalations/assets/CVE-2019-18634-screenshot-1_segmentation_fault.png)




<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>



### Nachweis 3: Erfolgreiche Rechteausweitung (Privilege Escalation)

Nach dem erfolgreichen Kompilieren und Ausf√ºhren des angepassten PoC-Exploits (basierend auf der Heap-Korrumpierung) erlangt der unprivilegierte Benutzer eine Root-Shell.

- **Aktion:** Ausf√ºhrung des kompilierten `exploit`-Programms .

- **Ergebnis:** Eine neue Shell wird mit der **User ID 0** (Root) gestartet. Der erfolgreiche Nachweis wird durch das Auslesen der Root-Flag-Datei erbracht.

```bash
# Nach erfolgreicher Ausf√ºhrung des Exploits:
whoami
# Ausgabe: root
cat /root/root.txt
# Ausgabe (TryHackMe Flag: THM{})
```

![CTF erlangt, durch das Auslesen von /root/root.txt](/04-host-security/angriffe/privilege_escalations/assets/CVE-2019-18634-screenshot-3_exploit_flag.png)



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## 4. Funktionsweise des Exploits (Konzeptionell)

Der **Proof-of-Concept** (PoC) Exploit, wie er auf [GitHub von Saleem Rashid](https://github.com/saleemrashid/sudo-cve-2019-18634) (u. a.) ver√∂ffentlicht wurde, nutzt typische Puffer√ºberlauf-Techniken, um die Ausf√ºhrung zu steuern.

<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Ziel der Heap-Korrumpierung

Das Ziel des Angriffs ist es, bestimmte Metadatenstrukturen im Heap-Speicher zu √ºberschreiben, die zur Verwaltung von Speicherbl√∂cken (Chunks) verwendet werden.

- **Ausl√∂sen des Overflows**: Der Exploit sendet eine gro√üe Anzahl von Bytes (oft Hunderte oder Tausende von Zeichen, z. B. `'A'` oder Null-Bytes) an das TTY-Ger√§t, um den festen Puffer zu f√ºllen und zu √ºberlaufen.

- **Korrumpierung**: Durch das √úberschreiben des Puffers wird die Metadatenstruktur des folgenden Heap-Chunks manipuliert, insbesondere dessen `fd` (Forward Pointer) und `bk` (Backward Pointer).

- **Arbitrary Write:** Bei der n√§chsten Speicherfreigabe (`free()`) oder -zuweisung (`malloc()`) versucht der C-Laufzeitumgebung (`glibc`), die korrumpierten Pointer zu verwenden, was zu einer √úberschreibung eines beliebigen Zielspeicherbereichs f√ºhrt.


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Exploit Code ‚Äì Konzeptionelle Logik

Der **exploit.c** Code ist darauf ausgelegt, die TTY-Schnittstelle zu manipulieren und das Payload zu senden. Der Kern der Payload-Generierung sieht konzeptionell so aus:

```text
/* Konzeptionelle Darstellung des Payload-Aufbaus: */
char payload[PAYLOAD_SIZE];
// ... [F√ºllung des Buffers bis zum √úberlaufpunkt]
// ... [√úberschreiben der Heap-Metadaten (fd/bk-Pointer)]
// ... [Hinzuf√ºgen der Adresse der Shellcode-Funktion]
// ... [Shellcode selbst (z.B. execve("/bin/sh", ...))]
```

Die **Shellcode-Funktion** ist ein winziges Programm, das nach erfolgreicher Korrumpierung ausgef√ºhrt wird. Ihr einziger Zweck ist es, eine Root-Shell (`/bin/sh` mit UID 0) zu starten.

Durch diese pr√§zise Korrumpierung wird die Ausf√ºhrung des Programms so umgeleitet, dass anstelle der regul√§ren Sudo-Logik die Shellcode des Angreifers ausgef√ºhrt wird - mit den Root-Rechten, die Sudo innehat.




<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## 5. Impact und Betroffene Systeme

Die Schwachstelle betraf eine breite Palette von Sudo-Versionen, jedoch nur unter der Voraussetzung, dass die `pwfeedback`-Option explizit aktiviert war.

- Sudo-Versionen von **1.7.1** bis **1.8.30** waren anf√§llig, wenn `pwfeedback` aktiviert war.

- Sudo **1.9.0** bis **1.9.1** waren ebenfalls anf√§llig, jedoch wurde die Option in neueren Versionen standardm√§√üig deaktiviert.

Viele Distributionen (insbesondere Debian und Ubuntu) hatten `pwfeedback` in ihren Standardkonfigurationen nicht aktiviert, was die Angriffsfl√§che verringerte, aber nicht ausschloss. Systeme in Entwicklungsumgebungen oder mit spezialisierten Security-Konfigurationen waren deutlich gef√§hrdeter.



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>



## 6. Gegenma√ünahmen (Mitigation)

Die Patches f√ºr CVE-2019-18634 wurden rasch in den Sudo-Quellcode integriert. Die empfohlenen Gegenma√ünahmen sind:


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### Patchen des Sudo-Pakets (Prim√§re Ma√ünahme)

Die wichtigste Abhilfema√ünahme ist die Aktualisierung auf eine nicht anf√§llige Sudo-Version:

- Sudo **1.8.31** und **1.9.2** oder h√∂her.

### Deaktivierung von `pwfeedback` (Fallback-Ma√ünahme)

Wenn ein sofortiges Update nicht m√∂glich ist, sollte die `pwfeedback`-Option aus der `/etc/sudoers`-Datei oder den entsprechenden Konfigurationsfragmenten entfernt werden.

Um sicherzustellen, dass die Option nicht aktiv ist, kann man in `/etc/sudoers` nach dem folgenden Eintrag suchen und ihn auskommentieren oder entfernen:

```text
#Defaults pwfeedback
```


<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


### H√§rtung (Hardening)

Regelm√§√üige Audits der `sudoers`-Konfiguration, um unn√∂tige oder potenziell gef√§hrliche Optionen zu identifizieren und zu entfernen, sind unerl√§sslich. Dazu geh√∂rt die strikte Einhaltung des "**Least Privilege**"-Prinzips.



<div align=right>

[‚Üë Inhaltsverzeichnis](#inhaltsverzeichnis)

</div>


## Haftungsausschluss

Dieses Repository dient ausschlie√ülich zu Ausbildungs-, Forschungs- und Demonstrationszwecken im Bereich der IT-Sicherheit.

Alle hier dokumentierten Techniken und Tools d√ºrfen nur in legalen und autorisierten Testumgebungen verwendet werden ‚Äì z.‚ÄØB. in Labors, CTFs oder mit ausdr√ºcklicher Genehmigung des Eigent√ºmers der Zielsysteme.

Wir distanzieren uns ausdr√ºcklich von jeglicher illegalen Nutzung.
Dieses Projekt richtet sich an White-Hat-Sicherheitsforscher, Ethical Hacker und Auszubildende, die ethisch und rechtlich korrekt handeln.

[Disclaimer](/00-disclaimer/disclaimer.md)

--- 

Stay curious ‚Äì stay secure. üîê

üóìÔ∏è **Letzte Aktualisierung:** Oktober 2025  
ü§ù **Pull Requests willkommen** ‚Äì Vorschl√§ge f√ºr neue Kurse oder Kategorien gerne einreichen!

---